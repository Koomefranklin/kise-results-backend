{% extends 'teaching_practice/base_site.html' %} 
{% load tz %}
{% block main %}
<div class="grid w-full h-full place-self-start gap-1">
	<div class="flex flex-col w-full gap-2">
		<form method="GET" action="{% url 'incomplete_assessments' %}" class='w-5/6 place-self-center'>  
			<div class='flex h-fit'>
				{{ search_query.search_query }}
				<button type="submit" class='rounded-md border p-2'>Search</button>
			</div>
		</form>
		{% include 'teaching_practice/filter_assessments.html' with filter_url='incomplete_assessments' %}
		<div class='grid gap-2 place-self-center shadow-2xl p-2 '>
			<button class='text-left'><a href='{% url "incomplete_assessments" %}'>Clear filters</a></button>
		</div>
		<table class="w-5/6 place-self-center border">
			<caption class=''>{{ tittle }}</caption>
			<thead class="border-b bg-gray-500 text-white p-2">
				<tr class="">
					
					<th class="px-2">Full Name</th>
					<th class="px-2">Assessment Number</th>
					<th class="px-2">School</th>
					<th class="px-2">Grade/Level</th>
					<th class='px-2'>Learning Area</th>
					<th class="px-2">Department</th>
					<th class="px-2">Date</th>
					<th class='px-2'>Time</th>
					<th class='px-2'>Assessor</th>
					<th class='px-2'>Assessment Type</th>
					<th class='px-2'>Score</th>
					<th class="">Actions</th>
				</tr>
			</thead>

			{% if page_obj %}
			<tbody class="capitalize">
				{% for letter in page_obj %}

				<tr
					class="{% cycle 'bg-gray-200 dark:text-black' 'bg-inherit' %} text-{% cycle 'bg-black' 'inherit' %} hover:bg-[#333] hover:text-white">
					<td class="px-2">
						<a href='{% url "edit_student_letter" letter.pk %}' class='w-full'>{{ letter.student.full_name }}</a>
					</td>
					<td class="px-2">{{ letter.student.index }}</td>
					<td class="px-2">{{ letter.school }}</td>
					<td class="px-2">{{ letter.grade }}</td>
					<td class="px-2">{{ letter.learning_area }}</td>
					<td class="px-2">{{ letter.student.department }}</td>
					<td class="px-2">{{ letter.created_at.date }}</td>
					<td class="px-2">{{ letter.created_at|localtime|time }}</td>
					<td class="px-2">{{ letter.assessor }}</td>
					<td class="px-2">{{ letter.assessment_type.name }}</td>
					<td class='px-2'>{{ letter.total_score }}</td>
					<td class="flex justify-between gap-2">
						<a href='{% url "edit_student_letter" letter.id %}' title='View'>View</a>
						
						{% if user.is_superuser %}
							<form action='{% url "delete_letter" letter.id %}' method='post' id='delete_letter_form'>
								{% csrf_token %}
								<button type='submit'>Delete</button>
							</form>
						{% else %}
						
						{% if letter.to_delete %}
							<form action='{% url "cancel_deletion" letter.pk request.build_absolute_uri %}' title='Cancel Deletion' method='post' id='cancel_deletion_form'>
								{% if not user.is_staff %}
									<input type='hidden' name='letter_id' value='{{ letter.pk }}'>
								{% endif %}
								{% csrf_token %}
								<button type='submit' class='font-bold'>Cancel Deletion</button>
							{% else %}
							<form action='{% url "request_deletion" letter.pk request.build_absolute_uri %}' title='Request Deletion' method='post' id='request_deletion_form'>
								{% csrf_token %}
								<button type='submit' class='font-bold'>Request Deletion</button>
							</form>
							{% endif %}
						{% endif %}
							
						
					</td>
				</tr>
				{% endfor %}
			</tbody>
			<tfoot class="bg-gray-500 text-white font-bold">
				<tr class="">
					<td colspan='12' class=''>
						<p class='w-full grid grid-flow-col'>
							<span class='text-left'>Showing {{ page_obj.object_list|length }} of {{ page_obj.paginator.count }} Student Assessments</span>
							<span class='text-right'>
								{% if page_obj.has_previous %}
								<a
									class="px-2"
									href="?page={{ page_obj.previous_page_number }}">
									Previous
								</a>
								{% endif %}
								PAGE: {{ page_obj.number }} of
								<a
									class="px-2"
									href="?page={{ page_obj.paginator.num_pages }}">
									{{ page_obj.paginator.num_pages }}
								</a>
								{% if page_obj.has_next %}
								<a
									class="px-2 bg-[#4caf50] rounded"
									href="?page={{ page_obj.next_page_number }}">
									Next
								</a>
								{% endif %}
							</span>
						</p>
					</td>
				</tr>
			</tfoot>
			{% else %}
			<tr class="">
				<td
					colspan="11"
					class="text-center">
					No Student Assessments Found
				</td>
			</tr>
			{% endif %}
		</table>
		
		{% for sectio in letter.student_sections.all %}
			{{section.section.name}}
		{% endfor %}
			
	</div>
</div>
<script>
	document.getElementById('delete_letter_form').addEventListener('submit', function(event) {
		const confirmed = confirm('Are you sure you want to delete this letter? This action cannot be undone.');
	
		if (!confirmed) {
			event.preventDefault(); 
		}
	});
	document.getElementById('cancel_deletion_form').addEventListener('submit', function(event) {
		const confirmed = confirm('Are you sure you want to cancel the deletion request for this letter?');
	
		if (!confirmed) {
			event.preventDefault(); 
		}
	});
	document.getElementById('request_deletion_form').addEventListener('submit', function(event) {
		const confirmed = confirm('Are you sure you want to request deletion of this letter? The request will be sent to the administrator for approval.');
	
		if (!confirmed) {
			event.preventDefault(); 
		}
	});
	</script>
{% endblock main %}